---
import { getCollection, render } from "astro:content";
import { Image } from "astro:assets";
import BookLayout from "@/layouts/BookLayout.astro";
import Header from "@/components/Header.astro";
import Footer from "@/components/Footer.astro";
import BackButton from "@/components/BackButton.astro";
import BuyLinks from "@/components/BuyLinks.astro";
import { SITE } from "@/config";
import { slugifyStr } from "@/utils/slugify";

// Generate static paths for all books
export async function getStaticPaths() {
  const books = await getCollection("books");

  // Filter out draft books in production
  const publishedBooks = books.filter(({ data }) => data.status !== "draft");

  return publishedBooks.map(book => ({
    params: { slug: book.id },
    props: { book },
  }));
}

const { book } = Astro.props;

const {
  title,
  description,
  longDescription,
  coverImage,
  publishDate,
  status,
  isbn,
  series,
  seriesOrder,
  buyLinks,
  downloadables,
  reviews,
  ogImage: initOgImage,
} = book.data;

// Render the MDX content
const { Content } = await render(book);

// Determine OG image (use coverImage if no specific ogImage provided)
let ogImageUrl: string | undefined;

if (typeof initOgImage === "string") {
  ogImageUrl = initOgImage;
} else if (initOgImage?.src) {
  ogImageUrl = initOgImage.src;
} else {
  // coverImage is now an image object, extract the src
  ogImageUrl = typeof coverImage === "string" ? coverImage : coverImage.src;
}

const ogImage = ogImageUrl
  ? new URL(ogImageUrl, Astro.url.origin).href
  : undefined;

// Status badge classes
const statusBadgeClass = {
  published: "bg-green-600 text-white",
  upcoming: "bg-blue-600 text-white",
  draft: "bg-gray-600 text-white",
}[status];

const statusLabel = {
  published: "Published",
  upcoming: "Coming Soon",
  draft: "Draft",
}[status];

// Format publish date
const formattedDate = publishDate.toLocaleDateString("en-US", {
  year: "numeric",
  month: "long",
  day: "numeric",
});

// Props for BookLayout
const layoutProps = {
  title: `${title} | ${SITE.title}`,
  description: description,
  ogImage,
  canonicalURL: new URL(Astro.url.pathname, Astro.url).href,
  pubDatetime: publishDate,
  scrollSmooth: true,
  // Book-specific props for structured data
  isbn,
  series,
  seriesOrder,
  status,
  buyLinks,
  reviews,
  // Convert coverImage to string for structured data
  coverImage: typeof coverImage === "string" ? coverImage : coverImage.src,
};
---

<BookLayout {...layoutProps}>
  <Header />
  <BackButton />

  <main
    id="main-content"
    class="mx-auto w-full max-w-app px-4 pb-12"
    data-pagefind-body
  >
    <!-- Book Header -->
    <div class="mb-8">
      <div class="mb-4 flex flex-wrap items-center gap-2">
        <span class={`rounded px-3 py-1 text-sm font-semibold uppercase ${statusBadgeClass}`}>
          {statusLabel}
        </span>
        {
          series && (
            <span class="rounded bg-muted px-3 py-1 text-sm font-medium text-foreground">
              {series} {seriesOrder && `#${seriesOrder}`}
            </span>
          )
        }
      </div>

      <h1
        transition:name={slugifyStr(title)}
        class="mb-2 text-3xl font-bold text-foreground sm:text-4xl lg:text-5xl"
      >
        {title}
      </h1>

      <p class="text-lg text-foreground/70">
        {status === "published" ? `Published ${formattedDate}` : `Coming ${formattedDate}`}
      </p>
    </div>

    <!-- Book Content Grid -->
    <div class="grid gap-8 lg:grid-cols-3">
      <!-- Cover Image and Buy Links Column -->
      <div class="lg:col-span-1">
        <div class="sticky top-4">
          <!-- Cover Image -->
          <Image
            src={coverImage}
            alt={`Cover of ${title}`}
            width={600}
            height={900}
            widths={[300, 600, 900]}
            sizes="(min-width: 1024px) 300px, (min-width: 640px) 400px, 100vw"
            class="mb-6 w-full rounded-lg shadow-2xl"
            loading="eager"
            decoding="async"
            format="webp"
            quality="high"
          />

          <!-- Buy Links -->
          <BuyLinks buyLinks={buyLinks} status={status} />

          <!-- ISBN -->
          {
            isbn && (
              <div class="mt-6 text-sm text-foreground/60">
                <span class="font-medium">ISBN:</span> {isbn}
              </div>
            )
          }
        </div>
      </div>

      <!-- Main Content Column -->
      <div class="lg:col-span-2">
        <!-- Short Description -->
        <div class="mb-8">
          <p class="text-xl leading-relaxed text-foreground/90">
            {description}
          </p>
        </div>

        <!-- Long Description -->
        {
          longDescription && (
            <div class="prose-custom mb-8">
              <h2 class="mb-4 text-2xl font-bold text-foreground">About This Book</h2>
              <div class="whitespace-pre-line text-foreground/80 leading-relaxed">
                {longDescription}
              </div>
            </div>
          )
        }

        <!-- MDX Content -->
        <article
          id="book-content"
          class="app-prose mb-8 max-w-none prose-headings:text-foreground prose-p:text-foreground/80 prose-strong:text-foreground prose-li:text-foreground/80"
        >
          <Content />
        </article>

        <!-- Reviews Section -->
        {
          reviews && reviews.length > 0 && (
            <div class="mb-8">
              <h2 class="mb-6 text-2xl font-bold text-foreground">Reviews & Praise</h2>
              <div class="space-y-6">
                {reviews.map(review => (
                  <blockquote class="border-l-4 border-accent bg-muted pl-6 py-4 pr-4">
                    <p class="mb-2 text-lg italic text-foreground/90">
                      "{review.quote}"
                    </p>
                    <footer class="text-sm font-medium text-foreground/70">
                      {review.attribution}
                    </footer>
                  </blockquote>
                ))}
              </div>
            </div>
          )
        }

        <!-- Downloadables Section -->
        {
          downloadables && downloadables.length > 0 && (
            <div class="mb-8">
              <h2 class="mb-6 text-2xl font-bold text-foreground">Downloads</h2>
              <div class="space-y-4">
                {downloadables.map(item => (
                  <div class="rounded-lg border border-border bg-muted p-4 transition-colors hover:border-accent">
                    <div class="flex items-start justify-between gap-4">
                      <div>
                        <h3 class="mb-1 text-lg font-semibold text-foreground">
                          {item.title}
                        </h3>
                        <p class="text-sm text-foreground/70">{item.description}</p>
                      </div>
                      <a
                        href={item.url}
                        download
                        class="flex-shrink-0 rounded bg-accent px-4 py-2 text-sm font-medium text-white transition-colors hover:bg-accent/90"
                      >
                        Download
                      </a>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          )
        }

        <!-- Back to Books Link -->
        <div class="mt-12 border-t border-border pt-8">
          <a
            href="/books"
            class="inline-flex items-center gap-2 font-medium text-accent hover:underline"
          >
            <svg
              class="h-5 w-5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M15 19l-7-7 7-7"
              />
            </svg>
            Back to All Books
          </a>
        </div>
      </div>
    </div>
  </main>

  <Footer />
</BookLayout>

<style>
  /* Custom prose styling for book content */
  .prose-custom {
    max-width: none;
  }

  .prose-custom h2 {
    font-weight: 700;
    margin-bottom: 1rem;
  }
</style>
