---
/**
 * Centralized SEO Component
 *
 * Generates all meta tags, Open Graph tags, Twitter Cards, and JSON-LD structured data
 * for different content types (website, article, book).
 *
 * This component consolidates SEO logic that was previously duplicated across
 * Layout.astro, BookLayout.astro, and NewsLayout.astro.
 */

import { SITE } from "@/config";

export interface Props {
  // Common props
  title?: string;
  description?: string;
  author?: string;
  profile?: string;
  ogImage?: string;
  canonicalURL?: string | URL;

  // Content type (defaults to "website")
  type?: "website" | "article" | "book";

  // Article/News specific
  pubDatetime?: Date;
  modDatetime?: Date;
  category?: string;
  image?: string;

  // Book specific
  isbn?: string;
  series?: string;
  seriesOrder?: number;
  status?: string;
  buyLinks?: Array<{ name: string; url: string }>;
  reviews?: Array<{ quote: string; attribution: string }>;
  coverImage?: string;

  // Additional options
  noindex?: boolean;
  nofollow?: boolean;
}

const {
  title = SITE.title,
  description = SITE.desc,
  author = SITE.author,
  profile = SITE.profile,
  ogImage = SITE.ogImage ? `/${SITE.ogImage}` : "/og.png",
  canonicalURL = new URL(Astro.url.pathname, Astro.url),
  type = "website",
  pubDatetime,
  modDatetime,
  category,
  image,
  isbn,
  series,
  seriesOrder,
  status,
  buyLinks = [],
  reviews = [],
  coverImage,
  noindex = false,
  nofollow = false,
} = Astro.props;

// Normalize canonical URL to URL object
const canonical = typeof canonicalURL === 'string'
  ? new URL(canonicalURL, Astro.url)
  : canonicalURL;

// Resolve social image URL
const socialImageURL = new URL(ogImage, Astro.url);

// Determine Open Graph type
const ogType = type === "website" ? "website" : type === "book" ? "book" : "article";

// Generate robots meta content
const robotsContent = [
  noindex ? "noindex" : "index",
  nofollow ? "nofollow" : "follow",
].join(", ");

// Generate structured data based on content type
let structuredData: Record<string, any>;

if (type === "book") {
  // Book schema (schema.org/Book)
  structuredData = {
    "@context": "https://schema.org",
    "@type": "Book",
    name: title,
    description: description,
    ...(isbn && { isbn: isbn }),
    author: {
      "@type": "Person",
      name: author,
      url: profile,
    },
    ...(coverImage && {
      image: new URL(coverImage, Astro.url.origin).href,
    }),
    ...(pubDatetime && { datePublished: pubDatetime.toISOString() }),
    ...(series && {
      isPartOf: {
        "@type": "BookSeries",
        name: series,
        ...(seriesOrder && { position: seriesOrder }),
      },
    }),
    ...(buyLinks.length > 0 && {
      offers: buyLinks.map(link => ({
        "@type": "Offer",
        availability:
          status === "published"
            ? "https://schema.org/InStock"
            : "https://schema.org/PreOrder",
        seller: {
          "@type": "Organization",
          name: link.name,
        },
        url: link.url,
      })),
    }),
    ...(reviews &&
      reviews.length > 0 && {
        review: reviews.map(review => ({
          "@type": "Review",
          reviewBody: review.quote,
          author: {
            "@type": "Person",
            name: review.attribution,
          },
        })),
      }),
  };
} else if (type === "article") {
  // NewsArticle schema (schema.org/NewsArticle)
  structuredData = {
    "@context": "https://schema.org",
    "@type": "NewsArticle",
    headline: title,
    description: description,
    ...(image && {
      image: new URL(image, Astro.url.origin).href,
    }),
    author: {
      "@type": "Person",
      name: author,
      url: profile,
    },
    publisher: {
      "@type": "Person",
      name: author,
      url: profile,
    },
    url: canonical.toString(),
    mainEntityOfPage: {
      "@type": "WebPage",
      "@id": canonical.toString(),
    },
    ...(pubDatetime && { datePublished: pubDatetime.toISOString() }),
    ...(modDatetime && { dateModified: modDatetime.toISOString() }),
    ...(category && { articleSection: category }),
  };
} else {
  // Default: BlogPosting schema (schema.org/BlogPosting)
  structuredData = {
    "@context": "https://schema.org",
    "@type": "BlogPosting",
    headline: title,
    image: socialImageURL.toString(),
    ...(pubDatetime && { datePublished: pubDatetime.toISOString() }),
    ...(modDatetime && { dateModified: modDatetime.toISOString() }),
    author: [
      {
        "@type": "Person",
        name: author,
        ...(profile && { url: profile }),
      },
    ],
  };
}
---

<!-- General Meta Tags -->
<title>{title}</title>
<meta name="title" content={title} />
<meta name="description" content={description} />
<meta name="author" content={author} />
<meta name="robots" content={robotsContent} />
<link rel="canonical" href={canonical} />
<link rel="sitemap" href="/sitemap-index.xml" />

<!-- Open Graph / Facebook -->
<meta property="og:type" content={ogType} />
<meta property="og:title" content={title} />
<meta property="og:description" content={description} />
<meta property="og:url" content={canonical} />
<meta property="og:image" content={socialImageURL} />
<meta property="og:site_name" content={SITE.title} />
<meta property="og:locale" content={SITE.lang || "en_US"} />

<!-- Article-specific Open Graph tags -->
{type === "article" && (
  <>
    {pubDatetime && (
      <meta property="article:published_time" content={pubDatetime.toISOString()} />
    )}
    {modDatetime && (
      <meta property="article:modified_time" content={modDatetime.toISOString()} />
    )}
    <meta property="article:author" content={author} />
    {category && <meta property="article:section" content={category} />}
  </>
)}

<!-- Book-specific Open Graph tags -->
{type === "book" && (
  <>
    {isbn && <meta property="book:isbn" content={isbn} />}
    {series && <meta property="book:series" content={series} />}
    <meta property="book:author" content={author} />
    {pubDatetime && (
      <meta property="article:published_time" content={pubDatetime.toISOString()} />
    )}
  </>
)}

<!-- Twitter Card -->
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:url" content={canonical} />
<meta name="twitter:title" content={title} />
<meta name="twitter:description" content={description} />
<meta name="twitter:image" content={socialImageURL} />

<!-- JSON-LD Structured Data -->
<script
  type="application/ld+json"
  is:inline
  set:html={JSON.stringify(structuredData)}
/>
