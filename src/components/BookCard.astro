---
import type { CollectionEntry } from "astro:content";
import { Image } from "astro:assets";
import { slugifyStr } from "@/utils/slugify";
import Datetime from "./Datetime.astro";
import Badge from "./Badge.astro";

export interface Props extends CollectionEntry<"books"> {
  variant?: "h2" | "h3";
}

const { variant = "h2", data, id } = Astro.props;

const {
  title,
  description,
  coverImage,
  series,
  seriesOrder,
  status,
  publishDate,
} = data;

const headerProps = {
  style: { viewTransitionName: slugifyStr(title) },
  class: "text-xl font-bold decoration-dashed hover:underline focus-visible:underline",
};

const statusLabel = {
  published: "Published",
  upcoming: "Coming Soon",
  draft: "Draft",
}[status];

const statusBadgeVariant = `status-${status}` as const;

// Generate aria-label for better screen reader support
const seriesInfo = series ? `${series}${seriesOrder ? ` Book ${seriesOrder}` : ''}` : '';
const ariaLabel = seriesInfo
  ? `${title}, ${seriesInfo}, ${statusLabel}`
  : `${title}, ${statusLabel}`;
---

<article
  class="group relative my-6 flex flex-col gap-4 rounded-lg border border-border p-4 transition-all hover:border-accent hover:shadow-md focus-within:border-accent focus-within:shadow-md sm:flex-row sm:gap-6"
>
  <div class="flex-shrink-0">
    <img
      src={coverImage}
      alt={`Cover of ${title}`}
      width="160"
      height="224"
      class="h-48 w-32 rounded object-cover shadow-md transition-transform group-hover:scale-105 sm:h-56 sm:w-40"
      loading="lazy"
      decoding="async"
    />
  </div>

  <div class="flex flex-1 flex-col">
    <div class="mb-2 flex flex-wrap items-center gap-2">
      <Badge variant={statusBadgeVariant} text={statusLabel} class="uppercase" />
      {
        series && (
          <Badge
            variant="series"
            text={`${series}${seriesOrder ? ` #${seriesOrder}` : ''}`}
            class="font-medium"
          />
        )
      }
    </div>

    <a
      href={`/books/${id}`}
      class="inline-block text-accent decoration-dashed underline-offset-4 focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-accent focus-visible:no-underline focus-visible:underline-offset-0"
      aria-label={ariaLabel}
    >
      {
        variant === "h2" ? (
          <h2 {...headerProps}>{title}</h2>
        ) : (
          <h3 {...headerProps}>{title}</h3>
        )
      }
      <span class="sr-only">
        {statusLabel}{series && `, ${seriesInfo}`}
      </span>
    </a>

    <div class="mt-1">
      <Datetime pubDatetime={publishDate} modDatetime={null} timezone={undefined} />
    </div>

    <p class="mt-2 flex-1 text-foreground/80">{description}</p>
  </div>
</article>
